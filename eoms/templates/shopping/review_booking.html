{% extends "index.html" %}
{% block title %}Booking Summary - AgriRent{% endblock %}

{% block css %}
<style>
    /* Stripe Elements styles */
    #payment-element {
        border: 1px solid #ced4da;
        padding: 1rem;
        border-radius: .25rem;
    }
    #payment-message {
        color: #fa755a;
        margin-top: 10px;
    }
    .spinner {
        display: none;
        border: 4px solid rgba(0, 0, 0, .1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s ease infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Booking Summary</h1>
    <div class="row">
        <!-- Left Side: Order Summary -->
        <div class="col-lg-7">
            <!-- Customer Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Customer Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ customer.first_name }} {{ customer.last_name }}</p>
                    <!-- THIS IS THE FIX: Get the email directly from the session -->
                    <p><strong>Email:</strong> {{ session.email }}</p>
                    <p><strong>Phone:</strong> {{ customer.phone }}</p>
                </div>
            </div>
            <!-- Booking Items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Booking Items</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% for item in cart_items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ item.name }} (x{{ item.qty }})
                        <span>₹{{"%.2f"|format(item.subtotal)}}</span>
                    </li>
                    {% endfor %}
                   <!-- <li class="list-group-item d-flex justify-content-between align-items-center">
                        GST
                        <span>₹{{"%.2f"|format(totals.total_gst)}}</span>
                    </li>-->
                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
                        Total
                        <span>₹{{"%.2f"|format(totals.cart_total)}}</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Right Side: Payment -->
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Payment Details</h5>
                </div>
                <div class="card-body">
                    <form id="payment-form">
                        <div id="payment-element" class="mb-3">
                          <!-- A Stripe Element will be inserted here. -->
                        </div>
                        <div class="d-grid">
                            <button id="submit-button" class="btn btn-success btn-lg">
                                <span id="button-text">Pay ₹{{"%.2f"|format(totals.cart_total)}}</span>
                                <div class="spinner" id="spinner"></div>
                            </button>
                        </div>
                        <!-- Used to display form errors. -->
                        <div id="payment-message" role="alert"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Stripe
        const stripe = Stripe("{{ config.STRIPE_PUBLISHABLE_KEY }}");

        // Create the payment intent on the server
        const { clientSecret, error: backendError } = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ note: '' }),
        }).then(r => r.json());

        if (backendError) {
            const messageContainer = document.querySelector('#payment-message');
            messageContainer.textContent = backendError.message;
            return;
        }
        
        if (!clientSecret) {
            const messageContainer = document.querySelector('#payment-message');
            messageContainer.textContent = "Could not initialize payment. Please try again or contact support.";
            return;
        }

        // Mount Stripe Elements
        const elements = stripe.elements({ clientSecret, appearance: { theme: 'stripe' } });
        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');

        // Handle form submission
        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('button-text');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            setLoading(true);

            // --- THIS IS THE FIX FOR THE RECEIPT REFRESH ISSUE ---
            // Add a timestamp to the return URL to prevent caching
            const returnUrl = new URL("{{ url_for('payment_success', _external=True) }}");
            returnUrl.searchParams.append('t', new Date().getTime());

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: returnUrl.toString(),
                },
            });

            if (error.type === "card_error" || error.type === "validation_error") {
                showMessage(error.message);
            } else {
                showMessage("An unexpected error occurred.");
            }

            setLoading(false);
        });

        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                spinner.style.display = 'inline-block';
                buttonText.style.display = 'none';
            } else {
                submitButton.disabled = false;
                spinner.style.display = 'none';
                buttonText.style.display = 'inline-block';
            }
        }

        function showMessage(messageText) {
            const messageContainer = document.querySelector("#payment-message");
            messageContainer.textContent = messageText;
        }
    });
</script>
{% endblock %}
